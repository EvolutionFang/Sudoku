import { settings } from './settings';
import { writable } from 'svelte/store';
import { getCandidateSet, getRecommendedStrategy } from '@sudoku/strategies';

export const usedHints = writable(0);

/**
 * Hint store with intelligent strategy recommendation logic.
 */
function createHints() {
    const hints = writable(Infinity);
    let defaultHints = Infinity;

    settings.subscribe(($settings) => {
        if ($settings.hintsLimited) {
            defaultHints = $settings.hints;
            hints.update($h => ($h > $settings.hints ? $settings.hints : $h));
        } else {
            defaultHints = Infinity;
            hints.set(Infinity);
        }
    });

    return {
        subscribe: hints.subscribe,

        useHint() {
            hints.update($h => {
                if ($h > 0) {
                    usedHints.update($u => $u + 1);
                    return $h - 1;
                }
                return 0;
            });
        },

        /**
         * Calculates the best strategy and updates the UI via a callback.
         * Resolves circular dependency by receiving updateKeyboard as a parameter.
         */
        handleSmartHint(grid, cursor, historyTree, updateKeyboard) {
            this.useHint();
            
            const recommendation = getRecommendedStrategy(grid);
            let strategyName = '';
            let finalCandidates = [];
            let hintText = '';

            if (recommendation?.strategy) {
                strategyName = recommendation.strategy;
                hintText = recommendation.reason || `Strategy: ${strategyName}`;
                const candidatesMap = getCandidateSet(grid, [strategyName]);
                finalCandidates = candidatesMap[cursor.y][cursor.x];
            } else {
                hintText = "Possible Numbers (Basic)";
                const candidatesBaseMap = getCandidateSet(grid, ['NakedSingle']);
                finalCandidates = candidatesBaseMap[cursor.y][cursor.x];
            }

            const triedNumbers = historyTree.getTriedForCell(cursor.x, cursor.y);
            
            updateKeyboard(finalCandidates || [], triedNumbers);

            return hintText;
        },

        reset() {
            hints.set(defaultHints);
            usedHints.set(0);
        }
    };
}

export const hints = createHints();